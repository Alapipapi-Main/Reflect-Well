/**
 * @file firestore.rules
 * @description Firestore Security Rules for the ReflectWell application.
 *
 * @version 1.1.0
 *
 * @summary
 * This ruleset enforces a strict, user-centric security model where all user-generated
 * content is isolated within a private data tree. The core philosophy is "path-based
 * ownership," meaning a user's identity, determined by their authentication UID,
 * dictates their access rights based on the document path.
 *
 * Data Structure:
 * - /users/{userId}: Private user profile document.
 * - /users/{userId}/journalEntries/{journalEntryId}: Private journal entries owned by the user.
 * - /users/{userId}/templates/{templateId}: Private journal templates owned by the user.
 * - /users/{userId}/settings/main: A private document for user settings.
 * - /moods/{moodId}: A global, read-only collection of available moods.
 * - /gratitudeWall/{gratitudePostId}: A public, append-only collection for anonymous gratitude posts.
 *
 * Key Security Decisions:
 * 1.  Strict Data Isolation: Users can only read or write data within their own
 *     path (`/users/{userId}/...`). Cross-user access is explicitly denied.
 * 2.  No User Enumeration: The top-level `/users` collection cannot be listed,
 *     preventing malicious actors from discovering all user IDs.
 * 3.  Read-Only Global Data: The `/moods` collection is public for all clients to read
 *     but cannot be modified, ensuring data integrity for this shared resource.
 * 4.  Denormalization for Authorization: User-generated content (e.g., JournalEntry)
 *     is expected to contain a `userId` field that matches the user's ID in the path.
 *     This avoids costly `get()` calls and ensures relational integrity.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId from the path.
     * This is the cornerstone of the ownership model.
     *
     * @param userId The user ID to check against the authenticated user's UID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Verifies ownership for an existing document. Used for update and delete
     * operations to prevent acting on non-existent data.
     *
     * @param userId The user ID to check against the authenticated user's UID.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that the user's document is being created correctly, enforcing
     * that the document's internal `id` field matches the user's UID.
     */
    function isCreatingSelf(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * Validates that the user's `id` field remains immutable on update.
     */
    function isUpdatingSelf(userId) {
      return isExistingOwner(userId) && request.resource.data.id == resource.data.id;
    }

    /**
     * Validates that a user is creating content within their own data tree and
     * correctly setting the back-reference `userId` field.
     */
    function isCreatingOwnContent(userId) {
      return isOwner(userId) && request.resource.data.userId == userId;
    }

    /**
     * Validates that the ownership link (`userId`) on a piece of content
     * remains immutable during an update.
     */
    function isUpdatingOwnContent(userId) {
      return isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
    }


    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to a user's own profile document.
     * @path /users/{userId}
     * @allow (get) A signed-in user ('user_abc') reading their own profile at `/users/user_abc`.
     * @deny (list) Any user attempting to list all documents in the `/users` collection.
     * @deny (create) A signed-in user ('user_abc') trying to create a profile for another user at `/users/user_xyz`.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isCreatingSelf(userId);
      allow update: if isUpdatingSelf(userId);
      allow delete: if isExistingOwner(userId);

      /**
       * @description Controls access to a user's private journal entries.
       * @path /users/{userId}/journalEntries/{journalEntryId}
       * @allow (create) A signed-in user ('user_abc') creating a new entry at `/users/user_abc/journalEntries/entry_123`.
       * @allow (list) A signed-in user ('user_abc') listing all their entries from `/users/user_abc/journalEntries`.
       * @deny (get) A signed-in user ('user_abc') attempting to read an entry from another user at `/users/user_xyz/journalEntries/entry_456`.
       * @principle Enforces strict document ownership within a user's private subcollection.
       */
      match /journalEntries/{journalEntryId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isCreatingOwnContent(userId);
        allow update: if isUpdatingOwnContent(userId);
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Controls access to a user's private journal templates.
       * @path /users/{userId}/templates/{templateId}
       * @allow A signed-in user can perform all operations on their own templates.
       * @deny Any user attempting to access another user's templates.
       * @principle Enforces strict document ownership for user-created templates.
       */
      match /templates/{templateId} {
        allow read, write: if isOwner(userId);
      }

      /**
       * @description Controls access to a user's private settings document.
       * @path /users/{userId}/settings/main
       * @allow (read, write) A signed-in user can manage their own settings.
       * @deny Any user attempting to access another user's settings.
       * @principle Enforces strict ownership for user-specific configuration.
       */
      match /settings/main {
        allow read, write: if isOwner(userId);
      }
    }

    /**
     * @description Defines access for the global 'moods' collection.
     * @path /moods/{moodId}
     * @allow (get, list) Any user (signed-in or anonymous) reading the list of available moods.
     * @deny (create, update, delete) Any client attempting to modify the moods collection. This data is managed by developers.
     * @principle Secures global, read-only data that is safe for public consumption.
     */
    match /moods/{moodId} {
      allow get: if true;
      allow list: if true;
      allow write: if false;
    }

    /**
     * @description Defines access for the global 'gratitudeWall' collection.
     * @path /gratitudeWall/{gratitudeId}
     * @allow (read) Any user can read posts on the gratitude wall.
     * @allow (create) Only signed-in users can create a new post.
     * @deny (update, delete) No one can edit or delete a post once it's created.
     * @principle Creates a public, immutable wall of gratitude.
     */
    match /gratitudeWall/{gratitudeId} {
        allow read: if true;
        allow create: if isSignedIn()
            && request.resource.data.text is string
            && request.resource.data.text.size() > 0
            && request.resource.data.text.size() <= 280
            && request.resource.data.authorId == request.auth.uid;
        allow update, delete: if false;
    }
  }
}
